<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<title>Game</title>
		<meta name="description" content="" />
		<meta name="author" content="acer" />

		<meta name="viewport" content="width=device-width initial-scale=1.0" />

		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		<style>
			html, body {
				width: 100%;
				height: 100%;
			}

			body {
				background-color: #ffffff;
				margin: 0;
				overflow: hidden;
				font-family: arial;
			}

			#blocker {

				position: absolute;
				width: 100%;
				height: 100%;
				background-color: rgba(0,0,0,0.5);
				z-index: 11;
			}

			#instructions {

				width: 100%;
				height: 100%;
				display: -webkit-box;
				display: -moz-box;
				display: box;
				-webkit-box-orient: horizontal;
				-moz-box-orient: horizontal;
				box-orient: horizontal;
				-webkit-box-pack: center;
				-moz-box-pack: center;
				box-pack: center;
				-webkit-box-align: center;
				-moz-box-align: center;
				box-align: center;
				color: #ffffff;
				text-align: center;
				cursor: pointer;
			}
			#pointer {
				width: 30px;
				height: 100%;
				opacity: 0.5;
				position: absolute;
				z-index: 10;
				background-color: red;
				border-radius: 15px;
				margin:0 auto;
				left:50%
				
			
			}
			#score {
				position: absolute;
				z-index: 100;
				font-size: 2em;
				font-weight: bold;
				color: #FFFFFF;
			}
		</style>

		<!-- 		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js" type="text/javascript" charset="utf-8"></script> -->
		<script src="build/three.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="./build/MathUtils.js" type="text/javascript" charset="utf-8"></script>
		<script src="./examples/obj/Bird.js" type="text/javascript" charset="utf-8"></script>
		<script src="./build/FlappyBird.js" type="text/javascript" charset="utf-8"></script>
		<script src="examples/js/renderers/Projector.js"></script>
		<script src="./examples/js/loaders/MTLLoader.js"></script>
		<script src="./examples/js/loaders/OBJLoader.js"></script>
		<script src="./examples/js/loaders/OBJMTLLoader.js"></script>
		<script src="./examples/js/controls/PointerLockControls.js"></script>
		<script src="build/blast.js"></script>

	</head>

	<body>
		<div id="blocker">

			<div id="instructions">
				<span style="font-size:40px">Click to play</span>
				<br />
				(W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
			</div>

		</div>
		<div id="container"></div>
<!-- 		<div id="pointer"></div> -->
		<div id="score">
			0
		</div>
		<script type="text/javascript" charset="utf-8">
			var Game = {
				scene : null,
				camera : null,
				renderer : null,
				container : null,
				controls : null,
				clock : null,
				stats : null,
				texture : null,
				score : 0,
				SCREEN_WIDTH : window.innerWidth,
				SCREEN_HEIGHT : window.innerHeight,
				raycaster : null,
				objGun : null,
				gunLight : null,
				clock : null,
				initX : 0,
				initY : 10,
				initZ : 0,
				initRotY : -(Math.PI),
				aEnemy : [],
				gunSite : null,
				aDeadEnemy : [],
				blast : null,
				viewline:null,
				particles:null,

				init : function() {// Initialization

					// create main scene
					oGame = this;
					this.clock = new THREE.Clock();
					this.scene = new THREE.Scene();
					// this.scene.fog = new THREE.FogExp2(0xcce0ff, 0.0003);

					// prepare camera
					var VIEW_ANGLE = 50, ASPECT = this.SCREEN_WIDTH / this.SCREEN_HEIGHT, NEAR = 1, FAR = 20000;

					this.camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
					this.scene.add(this.camera);
					// this.camera.position.set(0, 100, 300);
					//  this.camera.lookAt(new THREE.Vector3(0,0,0));

					//prepare point locker
					var blocker = document.getElementById('blocker');
					var instructions = document.getElementById('instructions');
					this.controls = new THREE.PointerLockControls(this.camera);
					this.scene.add(this.controls.getObject());
					var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

					if (havePointerLock) {

						var element = document.body;
						var pointerlockchange = function(event) {
							if (document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element) {
								Game.controls.enabled = true;
								//blocker.style.display = 'none';
							} else {
								oGame.controls.enabled = false;
								blocker.style.display = '-webkit-box';
								blocker.style.display = '-moz-box';
								blocker.style.display = 'box';
								instructions.style.display = '';
							}

						}
						var pointerlockerror = function(event) {

							instructions.style.display = '';

						}
						// Hook pointer lock state change events
						document.addEventListener('pointerlockchange', pointerlockchange, false);
						document.addEventListener('mozpointerlockchange', pointerlockchange, false);
						document.addEventListener('webkitpointerlockchange', pointerlockchange, false);

						document.addEventListener('pointerlockerror', pointerlockerror, false);
						document.addEventListener('mozpointerlockerror', pointerlockerror, false);
						document.addEventListener('webkitpointerlockerror', pointerlockerror, false);

						instructions.addEventListener('click', function(event) {
							instructions.style.display = 'none';

							// Ask the browser to lock the pointer
							element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

							if (/Firefox/i.test(navigator.userAgent)) {

								var fullscreenchange = function(event) {

									if (document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element) {

										document.removeEventListener('fullscreenchange', fullscreenchange);
										document.removeEventListener('mozfullscreenchange', fullscreenchange);

										element.requestPointerLock();
									}

								}

								document.addEventListener('fullscreenchange', fullscreenchange, false);
								document.addEventListener('mozfullscreenchange', fullscreenchange, false);
								element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

								element.requestFullscreen();

							} else {

								document.addEventListener('click', checkBirdHit)
								element.requestPointerLock();

							}

						}, false);

					} else {

						instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

					}

					// prepare renderer
					this.renderer = new THREE.WebGLRenderer({
						antialias : true
					});
					this.renderer.setSize(this.SCREEN_WIDTH, this.SCREEN_HEIGHT);
					this.renderer.setClearColor(0x0000ff);
					this.renderer.shadowMapEnabled = true;
					this.renderer.shadowMapSoft = true;

					// prepare container
					this.container = document.getElementById('container');
					document.body.appendChild(this.container);
					this.container.appendChild(this.renderer.domElement);

					// var boxgeom = new THREE.BoxGeometry(5,5,5);
					// var met 	= new THREE.MeshBasicMaterial({color:0xff00ff});
					// var boxmesh = new THREE.Mesh(boxgeom, met);
					// boxmesh.name = 'box';
					// this.scene.add(boxmesh);
					// boxmesh.position.set(0,0, -100);
					//
					// add spot light
					var spLight = new THREE.SpotLight(0xffffff, 1.75, 2000, Math.PI / 3);
					spLight.castShadow = true;
					spLight.position.set(-100, 300, -50);
					// this.scene.add(spLight);

					var light = new THREE.AmbientLight(0x404040);
					// soft white light
					this.scene.add(light);

					// add gun light
					this.gunLight = new THREE.SpotLight(0xffffff);
					this.gunLight.position.y = 500;

					this.gunSite = this.makeGunSite();
					this.gunSite.scale.multiplyScalar(0.2);
					this.gunSite.name = "gunsite";
					this.gunSite.position.set(0, 0, -50);
					this.scene.add(this.gunSite);

					// // add simple ground
					// var ground = new THREE.Mesh( new THREE.BoxGeometry(100, 100, 10), new THREE.MeshLambertMaterial({color:0x999999}) );
					// ground.receiveShadow = true;
					// ground.position.set(0, 0, 100);
					// ground.rotation.x = -Math.PI / 2;
					// this.scene.add(ground);
					var skybox = makeSkybox(['examples/textures/cube/skybox/px.jpg', // right
					'examples/textures/cube/skybox/nx.jpg', // left
					'examples/textures/cube/skybox/py.jpg', // top
					'examples/textures/cube/skybox/ny.jpg', // bottom
					'examples/textures/cube/skybox/pz.jpg', // back
					'examples/textures/cube/skybox/nz.jpg' // front
					], 8000);
					skybox.name = "skybox";
					//this.scene.add(skybox);

					// this.scene.add( makePlatform(
					// 'examples/models/platform/platform.json',
					// 'examples/models/platform/platform.jpg',
					// Game.renderer.getMaxAnisotropy()
					// ));

					// load a model
					this.loadTexture();
					this.loadModel();
					this.createEnemy();
					animate();
					// this.loadMTLOBJ()
				},
				loadTexture : function() {
					var oGame = this;
					var manager = new THREE.LoadingManager();
					manager.onProgress = function(item, loaded, total) {
						//console.log( item, loaded, total );
					};

					var loader = new THREE.ImageLoader(manager);

					this.texture = new THREE.Texture();
					loader.load('./models/MP5K/Tex_0004_1.png', function(image) {
						oGame.texture.image = image;
						oGame.texture.needsUpdate = true;

					});
				},
				loadMTLOBJ : function() {
					var loader = new THREE.OBJMTLLoader();
					loader.load('../models/MP5K/MP5K.obj', '../models/MP5K/MP5K.mtl', function(object) {

						object.position.y = -80;
						Game.scene.add(object);

					}, this.onProgress, this.onError);

				},
				makeGunSite : function() {
					var loader = new THREE.ImageLoader(manager);
					var manager = new THREE.LoadingManager();
					manager.onProgress = function(item, loaded, total) {
						//console.log( item, loaded, total );
					};

					var gunsitetexture = new THREE.Texture();
					var gunsitetexture_alpha = new THREE.Texture();
					loader.load('./examples/textures/gun-sight_alpha.jpg', function(image) {
						gunsitetexture_alpha.image = image;
						gunsitetexture_alpha.needsUpdate = true;
					});
					loader.load('./examples/textures/gun-sight.jpg', function(image) {
						gunsitetexture.image = image;
						gunsitetexture.needsUpdate = true;
					});

					var geometry = new THREE.PlaneGeometry(100, 100, 10);

					var material = new THREE.MeshBasicMaterial({
						color : 0xffffff,
						map : gunsitetexture,
						alphaMap : gunsitetexture_alpha,
						transparent : true
					})
					var mesh = new THREE.Mesh(geometry, material);
					// geometry.applyMatrix(new THREE.Matrix4().makeTranslation(50, 0 , depth/2));
					// centerbox.position.set(-width / 2, -height / 2, -depth / 2);
					// centerbox.rotation.set(0, 0, 0);
					mesh.rotation.x = -(Math.PI / 2);
					mesh.doubleSided = true;
					return mesh;
				},
				loadModel : function() {
					// prepare loader and load the model
					var oGame = this;
					var oLoader = new THREE.OBJLoader();
					oLoader.load('./models/MP5K/MP5K.obj', function(object, materials) {

						// var material = new THREE.MeshFaceMaterial(materials);
						var material2 = new THREE.MeshLambertMaterial({
							color : 0xa65e00
						});
						oGame.objGun = object;
						oGame.objGun.name = "gun";
						oGame.objGun.traverse(function(child) {
							if ( child instanceof THREE.Mesh) {

								// apply custom material
								child.material.map = oGame.texture;

								// enable casting shadows
								child.castShadow = true;
								child.receiveShadow = true;
								// oGame.objGun.rotation._z = 90 ;
							}
						});
						oGame.camera.add(oGame.objGun);
						oGame.objGun.position.set(5, -45, -120);
						oGame.objGun.rotation.set(Math.PI / 18, -Math.PI * 0.99, 0, 'XYZ');
						//oGame.objGun.scale.set(1, 1, 1);
						oGame.scene.add(oGame.gunLight);
						Game.gunLight.target = Game.objGun;
						oGame.camera.updateProjectionMatrix();

					});
				},
				createEnemy : function() {
					console.log('create enemy');
					var material = new THREE.MeshBasicMaterial({
						color : 0xff0000,
						side : THREE.DoubleSide
					});
					Game.controls.update();
					var controlObj = Game.controls.getObject();
					var pitchObj = Game.controls.pitchObject();
					var delta = Game.clock.getDelta();
					var theta = controlObj.rotation.y + (Math.random(Math.PI/2) - Math.PI/4);
					var phi = (Math.PI / 2) - pitchObj.rotation.x;

					
					
					var birdMesh = new FlappyBird(material, 1, (Math.random() * 50 + 500), 100, theta, phi);
					var camRotation = this.controls.getRotation();
					birdMesh.scale.set(5,5,5);
					birdMesh.name = 'enemy';
					birdMesh.rotation.set(-(phi - (Math.PI / 2)), theta + (Math.PI /  2), 0, 'YXZ');
					this.scene.add(birdMesh);
					
					if(this.aEnemy.length == undefined){
						this.aEnemy.push(birdMesh);
					}else{
						
						this.aEnemy[0] = birdMesh;
					}
					render();
				}
			};

			// Animate the scene
			function animate() {
				requestAnimationFrame(animate);

				// update();
				render();
			}

			// Update controls and stats
			function checkBirdHit(event) {
				// Game.controls.update(Game.clock.getDelta());
				event.preventDefault();
				var controlObj = Game.controls.getObject();
				var mouse = new THREE.Vector3();
				mouse.x = (event.clientX / window.innerWidth ) * 2 - 1;
				mouse.y = -(event.clientY / window.innerHeight ) * 2 + 1;
				console.log(event.clientX +' | '+ event.clientY);
				var raycaster = new THREE.Raycaster()
				var vector = new THREE.Vector3(0, 0, 1).unproject(Game.camera);

				raycaster.set(Game.camera.position, vector.sub(controlObj.position).normalize());
				if (Game.aEnemy.length > 0) {
					
					var intersections = raycaster.intersectObject(Game.aEnemy[0]);
				
					if (intersections && intersections.length > 0) {
					console.log('hitObject intersections.length ' + intersections.length);
						for (var i = 0; i < intersections.length; i++) {
							var hitObject = intersections[i].object;
							// hitObject.scale.multiplyScalar(2);
							if (hitObject.name == 'enemy') {
								Game.score++;
								document.getElementById('score').innerHTML = Game.score;
								createBlast(hitObject);
								
								break;
							}
						}
	
					}
				}

			}

			function createBlast(enemy) {
				var gemoetry =  new Bird();
				Game.blast = new Blast(gemoetry, 0xff0000, 70, function() {
					console.log('blast over');
					Game.scene.remove(Game.particles);
					Game.particles = null;
					Game.blast = null;
					
					Game.createEnemy();
				}, this);
				Game.particles 	= Game.blast.createParticle()
				Game.scene.add(Game.particles);
				Game.particles.position.copy(enemy.position.clone());
				removeEnemy();
//				particles.rotation.copy((enemy.rotation.clone()))
			};

			// Render the scene
			function render() {
				//var pointer = document.getElementById("pointer");
				//pointer.style.left = mouse
				Game.controls.update();
				var controlObj = Game.controls.getObject();
				var pitchObj = Game.controls.pitchObject();
				var delta = Game.clock.getDelta();
				var theta = controlObj.rotation.y;
				var phi = (Math.PI / 2) - pitchObj.rotation.x;
				//console.log('controls rotation = '+ JSON.stringify(Game.controls.getRotation()) );
				if (Game.aEnemy.length > 0) {
					var diff = Game.aEnemy[0].animate(controlObj, 2, delta);
					var diff = Game.aEnemy[0].attack(controlObj, theta, phi, 2, delta);
					if (diff <= 5) {
						removeEnemy();
						Game.createEnemy();
					}

				}
				
				
				Game.gunSite.position.copy(controlObj.position.clone().sub(getLocation(theta, phi, 90)));
				Game.gunSite.position.y -= 5;//(controlObj.position.clone().sub(getLocation(theta, phi, 50)));
				Game.gunSite.rotation.set(-(phi - (Math.PI / 2)), theta, 0, 'YXZ');

				if (Game.blast) {
					Game.blast.animateParticles(delta);
				}

				//	console.log(' theta= '+(theta * (180/Math.PI))+ ' | phi = '+ (phi * (180/Math.PI)));
				Game.renderer.render(Game.scene, Game.camera);

			}

			var removeEnemy = function() {
				for(var i = 0; i< Game.aEnemy.length;i++){
					var enemy = Game.aEnemy[i];
					Game.scene.remove(enemy);
					enemy= null;
					
				}
				Game.aEnemy = [];
				
			}
			var getLocation = function(theta, phi, radius) {
				var x = (radius * Math.sin(phi) * Math.sin(theta));
				var y = (radius * Math.cos(phi));
				var z = (radius * Math.sin(phi) * Math.cos(theta));
				return new THREE.Vector3(x, -y, z);
			}
			// Initialize lesson on page load
			function initGame() {
				Game.init();

			}

			function onWindowResize() {

				Game.SCREEN_Height = window.innerWidth / 2;
				Game.SCREEN_HEIGHT = window.innerHeight / 2;

				Game.camera.aspect = window.innerWidth / window.innerHeight;
				Game.camera.updateProjectionMatrix();

				Game.renderer.setSize(window.innerWidth, window.innerHeight);

			}

			function updateGun() {

			}

			// init 3D stuff

			function makeSkybox(urls, size) {
				// console.log(urls + ' | '+ size);
				var skyboxCubemap = THREE.ImageUtils.loadTextureCube(urls);

				skyboxCubemap.format = THREE.RGBFormat;

				var skyboxShader = THREE.ShaderLib['cube'];
				skyboxShader.uniforms['tCube'].value = skyboxCubemap;

				return new THREE.Mesh(new THREE.BoxGeometry(size, size, size), new THREE.ShaderMaterial({
					fragmentShader : skyboxShader.fragmentShader,
					vertexShader : skyboxShader.vertexShader,
					uniforms : skyboxShader.uniforms,
					depthWrite : false,
					side : THREE.BackSide
				}));
			};

			function makePlatform(jsonUrl, textureUrl, textureQuality) {
				var placeholder = new THREE.Object3D();

				var texture = THREE.ImageUtils.loadTexture(textureUrl);
				texture.anisotropy = textureQuality;

				var loader = new THREE.JSONLoader();
				loader.load(jsonUrl, function(geometry) {

					geometry.computeFaceNormals();

					var platform = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({
						map : texture
					}));

					platform.name = "platform";

					placeholder.add(platform);
				});

				return placeholder;
			};

			function smoke() {
				var smokeTexture = THREE.ImageUtils.loadTexture('./smoke.png');
				var smokeMaterial = new THREE.ParticleBasicMaterial({
					map : smokeTexture,
					transparent : true,
					blending : THREE.AdditiveBlending,
					size : 50,
					color : 0x111111
				});
			}


			window.addEventListener('resize', onWindowResize);
			if (window.addEventListener)
				window.addEventListener('load', initGame, false);
			else if (window.attachEvent)
				window.attachEvent('onload', initGame);
			else
				window.onload = initGame;
		</script>
	</body>
</html>
